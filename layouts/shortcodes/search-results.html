<div id="search-results" class="is-hidden">
  <h3 class="title">Results for &laquo; <span id="search-query"></span> &raquo;</h3>
  <ul id="search-lunr"></ul>
</div>

<script type="application/javascript">
  const do_search = async () => {
    const params = new URLSearchParams(window.location.search)

    if (params.has('query'))
    {
      const index = await $.getJSON("/search-index.json")

      const data = {
        query: $('#search-query'),
        target: $('#search-lunr'),
        index: elasticlunr.Index.load(index)
      }

      let results

      try {
        data.query.text(params.get('query'))
        results = data.index.search(params.get('query'), {
          bool: 'AND'
        })
      }
      catch (err) {
        results = []
      }

      results.forEach(match => {
        const item = match.doc

        const el = $('<li/>')
        const link = $('<a/>', { href: item.uri })

        link.text(item.title)
        el.append(link)
        data.target.append(el)
      })

      if (results.length === 0) {
        const el = $('<li/>')
        el.text('No result found.')
        data.target.append(el)
      }

      const block = document.getElementById('search-results')
      block.classList.remove('is-hidden')
    }
  }

  $(() => {
    do_search().catch(err => { throw err })
  })
</script>
